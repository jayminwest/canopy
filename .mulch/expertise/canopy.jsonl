{"type":"failure","description":"--add-section in update.ts ignored --body: addSectionBody declared but never assigned by the arg parser","resolution":"Added name=body shorthand and --body lookahead to --add-section parsing, mirroring --section in create.ts. Removed stale sectionBody fallback. Wired --body through commander registration.","classification":"tactical","recorded_at":"2026-02-24T13:42:08.965Z","evidence":{"commit":"845828e"},"id":"mx-e78d97"}
{"type":"pattern","name":"section-arg-parsing","description":"CLI arg parsing for section flags: use indexOf('=') for name=body shorthand detection and lookahead (args[i+1] === '--body') for the two-flag form. Both create.ts --section and update.ts --add-section/--section follow this pattern. When adding new section-like flags, always implement both forms.","classification":"tactical","recorded_at":"2026-02-24T13:42:20.267Z","evidence":{"commit":"845828e"},"id":"mx-4f2107"}
{"type":"convention","content":"Commander registration must mirror raw arg parsing: when a flag accepts --body, the .action() handler must also forward opts.body to the args array. See update.ts lines 231-238 where --section and --add-section both conditionally push --body.","classification":"tactical","recorded_at":"2026-02-24T13:42:26.042Z","evidence":{"commit":"845828e"},"id":"mx-5025e9"}
{"type":"pattern","name":"repeatable-section-flags","description":"Repeatable section flags in update.ts: convert single addSectionName/addSectionBody vars to addSections[]{name,body} array; convert removeSectionName to removeSections[]. Parsing loop pushes into arrays (same lookahead for --body). Mutation loops over arrays. Commander registration uses accumulator (v,a)=>a.concat([v]) matching --tag pattern. .action() iterates arrays to rebuild args.","classification":"tactical","recorded_at":"2026-02-24T14:40:58.199Z","outcomes":[{"status":"success","agent":"update-builder"}],"id":"mx-2603c9"}
{"type":"pattern","name":"remove-section-splice-pattern","description":"--remove-section behavior: for non-inheriting prompts (no extends field), splice the section from the array entirely. For inheriting prompts (has extends), use body='' to suppress the inherited section during render. This avoids noise entries in the JSONL store.","classification":"tactical","recorded_at":"2026-02-24T14:46:50.220Z","outcomes":[{"status":"success","agent":"remove-section-builder"}],"id":"mx-54581e"}
{"type":"failure","description":".gitattributes check in init.ts used includes('merge=union') which is too broad: if seeds/mulch already added merge=union entries for their own JSONL files, canopy entries were silently skipped.","resolution":"Check for canopy-specific path (.canopy/prompts.jsonl) instead of generic merge=union string. Added test to verify entries are appended even when other tools' merge=union lines exist.","classification":"tactical","recorded_at":"2026-02-24T14:56:22.484Z","outcomes":[{"status":"success","agent":"init-fix-builder"}],"id":"mx-4e08f1"}
{"type":"pattern","name":"multi-issue-lead-falloff","description":"Leads dispatched with multiple issues (different files) may only complete the primary sling issue and exit. For best coverage, dispatch one lead per issue or accept that a second lead may be needed for remaining issues.","classification":"tactical","recorded_at":"2026-02-24T14:58:40.029Z","id":"mx-b8bcc6"}
{"type":"pattern","name":"brand-palette-output","description":"Brand palette constants in output.ts: export palette.brand (chalk.rgb(56,142,60) deep green), palette.accent (chalk.rgb(255,183,77) amber for IDs), palette.muted (chalk.rgb(120,120,110) stone gray for metadata). Legacy c helpers delegate to palette where applicable (green→brand, yellow→accent).","classification":"tactical","recorded_at":"2026-02-24T17:11:36.171Z","outcomes":[{"status":"success","agent":"palette-dim-builder"}],"id":"mx-0c887e"}
{"type":"pattern","name":"style-a-help-screen","description":"Style A help screen pattern for Commander CLI: override formatHelp via configureHelp(), check cmd.parent to delegate subcommand help to Commander default, iterate cmd.commands dynamically for command list, use palette.brand(chalk.bold) for tool name, palette.muted for version, chalk.green for command names, chalk.dim for args/flags, 18-char field with 2-space min gap for column alignment.","classification":"tactical","recorded_at":"2026-02-24T17:21:26.291Z","outcomes":[{"status":"success","agent":"help-screen-builder"}],"id":"mx-e37941"}
{"type":"pattern","name":"palette-chalk-instance-style","description":"palette in output.ts should use direct chalk instances (chalk.rgb(56,142,60)) not arrow function wrappers. Instances support chaining (palette.brand.bold(...)); arrow functions do not. All fmt helpers in output.ts rely on this.","classification":"tactical","recorded_at":"2026-02-24T17:47:12.900Z","outcomes":[{"status":"success","agent":"merge-fix-builder"}],"id":"mx-9f51e1"}
{"type":"pattern","name":"visual-branding-dispatch","description":"Visual branding overhaul dispatch pattern: palette (output.ts) must merge first since downstream tasks (icons, messages, highlighting) depend on palette constants. Phase 1: single lead for palette. Phase 2: parallel leads — one for help screen (index.ts), one for all command file changes (icons+messages+highlighting combined to avoid file area overlap).","classification":"tactical","recorded_at":"2026-02-24T17:49:36.899Z","id":"mx-23c03b"}
{"type":"failure","description":"Icons builder branch forked before palette merge caused merge conflict in output.ts (arrow functions vs chalk instances). Auto-merge-resolve failed.","resolution":"Dispatch a merge-fix lead to reimplement changes on updated main. Prevention: when Phase 2 leads depend on Phase 1 merges to shared files, ensure Phase 2 worktrees are created AFTER the Phase 1 merge.","classification":"tactical","recorded_at":"2026-02-24T17:49:42.973Z","id":"mx-bcab79"}
{"type":"pattern","name":"cli-standards-alignment","description":"CLI standards alignment: quiet flag (module-level _quiet + setQuiet + gate humanOut), verbose flag (declare-only), --version --json rich metadata (rawArgs before Commander), doctor command (8 checks: config, prompts-integrity, schemas-integrity, schema-validation, inheritance, emit-staleness, stale-locks, version-sync), upgrade command (npm registry fetch + bun install -g). Doctor reads VERSION by parsing index.ts source to avoid side-effect imports from index.ts.","classification":"tactical","recorded_at":"2026-02-24T21:33:45.144Z","id":"mx-2b3dcc"}
{"type":"pattern","name":"update-command-test-pattern","description":"update.ts integration test pattern: 22 tests covering section add/remove/replace (--section --body, name=body shorthand, --add-section), tag mutations (--tag/--untag, repeatable), metadata updates (--name, --description, --schema, --extends, --emit-as, --status), version bump, JSON output, and ExitError on missing prompt. Use same tmpDir/captureOutput/beforeEach pattern as create.test.ts with tmpDir='.test-tmp-update'.","classification":"tactical","recorded_at":"2026-02-25T14:40:11.417Z","outcomes":[{"status":"success","agent":"update-test-builder"}],"id":"mx-23198f"}
{"type":"pattern","name":"sync-test-git-repo-pattern","description":"sync.test.ts integration test pattern: use real git repos (git init in /tmp/cn-test-... path outside any existing repo) rather than mocking Bun.spawnSync. Initialize with git config user.email/name + initial commit on .canopy/. Tests cover: clean state, successful commit, date in commit message, --status human+json, --json flag, ExitError on non-git dir.","classification":"tactical","recorded_at":"2026-02-25T14:40:46.582Z","outcomes":[{"status":"success","agent":"sync-test-builder"}],"id":"mx-35af39"}
{"type":"pattern","name":"store-lock-concurrency-test-pattern","description":"Lock concurrency testing pattern for store.ts: use Promise.all with 5 concurrent acquire/sleep/write/release sequences to verify serialization; backdate lock mtime by 31s (>LOCK_STALE_MS=30000ms) via node:fs/promises utimes to test stale cleanup; create fresh lock file and race acquireLock with 6s setTimeout to verify LOCK_TIMEOUT_MS=5000ms throws /timeout/i.","classification":"tactical","recorded_at":"2026-02-25T14:40:48.593Z","outcomes":[{"status":"success","agent":"store-lock-builder"}],"id":"mx-65533b"}
{"type":"pattern","name":"list-test-archived-pattern","description":"list.test.ts integration test pattern: use update() to set archived status (create only supports draft|active). Test archived exclusion by creating a prompt then updating it to archived via update(['name', '--status', 'archived'], false).","classification":"tactical","recorded_at":"2026-02-25T14:41:15.673Z","outcomes":[{"status":"success","agent":"list-test-builder"}],"id":"mx-9e2bac"}
{"type":"pattern","name":"archive-test-pattern","description":"archive.test.ts pattern: use tmpDir = join(import.meta.dir, '../../.test-tmp-<cmd>'), captureOutput helper, beforeEach init + chdir, afterEach rmSync. Import archive, create, init, update from commands. Tests: happy path, JSON output, not-found error, already-archived error, JSONL state verification via readJsonl+dedupById, and unarchive via update --status active.","classification":"tactical","recorded_at":"2026-02-25T14:41:19.342Z","outcomes":[{"status":"success","agent":"archive-test-builder"}],"id":"mx-80fe0b"}
{"type":"pattern","name":"array-at-for-typecheck","description":"Use Array.prototype.at(0) and at(-1) instead of index access [0]/[length-1] in TypeScript test assertions — avoids 'undefined' assignability errors in strict mode when biome forbids non-null assertions.","classification":"tactical","recorded_at":"2026-02-25T14:41:49.938Z","outcomes":[{"status":"success","agent":"history-test-builder"}],"id":"mx-83adb6"}
{"type":"pattern","name":"capture-output-throw-pattern","description":"When testing CLI commands that call jsonOut then throw ExitError, captureOutput helper loses stdout (it re-throws without returning). Use inline console.log capture + finally restore to recover JSON written before the throw.","classification":"tactical","recorded_at":"2026-02-25T14:41:18.803Z","outcomes":[{"status":"success","agent":"pin-test-builder"}],"id":"mx-e33a54"}
{"type":"pattern","name":"show-test-pattern","description":"show.test.ts pattern: tests for cn show cover name lookup, --json output (parsed JSON assertions), name@version pinned-version lookup, nonexistent prompt/version (ExitError), section body display in human output, description/tags display, missing name arg error. Follow create.test.ts structure exactly: captureOutput helper, tmpDir per file, chdir in try/finally.","classification":"tactical","recorded_at":"2026-02-25T14:40:55.584Z","outcomes":[{"status":"success","agent":"show-test-builder"}],"id":"mx-f2b6ba"}
{"type":"failure","description":"tree.ts renderChildren and buildTree functions lack cycle detection: cycles in prompt inheritance cause stack overflow in both human and JSON output modes. The ancestor traversal has a guard (ancestors.includes check) but the child-rendering functions do not.","resolution":"Add a 'visited' Set parameter to renderChildren and buildTree to skip already-seen prompt names.","classification":"tactical","recorded_at":"2026-02-25T14:42:08.543Z","outcomes":[{"status":"success","agent":"tree-test-builder"}],"id":"mx-dce42e"}
{"type":"pattern","name":"test-batch-parallelization","description":"Test coverage batch: 9 independent test files dispatched as 3 leads x 3 builders for maximum parallelization. All test files are disjoint (each writes to a unique .test.ts), enabling conflict-free parallel merges. Total: 186 tests across 21 files.","classification":"tactical","recorded_at":"2026-02-25T14:43:45.792Z","id":"mx-e6cf6b"}
{"type":"pattern","name":"emit-frontmatter-pattern","description":"emit.ts promptToMarkdown pattern: rename sectionsToMarkdown to promptToMarkdown, accept frontmatter+name+description params, build combined frontmatter {name, description?, ...userKeys}, call renderFrontmatter, prepend to sections with blank line separator. All three call sites (emitPrompt, checkMode, single-emit) must be updated consistently.","classification":"tactical","recorded_at":"2026-02-25T20:39:24.452Z","outcomes":[{"status":"success","agent":"emit-fm-builder"}],"id":"mx-2892cd"}
